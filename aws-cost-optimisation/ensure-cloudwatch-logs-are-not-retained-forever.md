# Ensure Cloudwatch logs are not retained forever

By default cloudwatch logs are retained forever by AWS. The default AWS retention setting for cloudwatch log groups is set to "Never Expire" when the retention setting is not explicitely specified. Not specifying the retention period leads to cloudwatch logging costs continually increasing day by day as more and more log events are stored in Cloudwatch. 

In addition, many log groups are created implicitely when using other AWS services. For example AWS lambda will typically create a log group for each new function automatically for you. It's not uncommon to have 100s of log groups where log events are retained forever in a fairly short amount of time within an enterprise setting. 

Cloudwatch log storage is priced at $0.03 per GB stored per month (at time of writing) so is inexpensive and typically not seen as problematic, at least to begin with. Over time the cost of log storage in cloudwatch can become a problem if a large amount of logging is generated by your AWS workloads, stored in Cloudwatch logs and also retained forever. 

### Therefore

Cloudwatch log groups can be configured to automatically delete logs based on a retention setting against each log group. Log events older than the retention setting will be automatically deleted and related storage costs will no longer be incurred.

To avoid cloudwatch log storage costs continually increasing over time ensure that _all_ cloudwatch log groups have specified a retention setting that isn't the default "Never Expire". The retention setting can be set at various durations from 1 day to 10 years. 

## Identifying log groups with "Never Expire" retention

The "Never Expire" retention setting is represented as a missing retentionInDays property in the AWS Cloudwatch Logs API response for [DescribeLogGroups](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DescribeLogGroups.html). The following AWS CLI command selects log groups without a retention setting, within the default region of a single AWS account. 

```aws logs describe-log-groups --query 'logGroups[?!not_null(retentionInDays)]'```

Note the double negative in the query expression with ! (not) applied to not_null(retentionInDays) in the JMESPath expression to select log groups with a missing retentionInDays setting. 

#### Useful AWS CLI docs:
* See the [aws logs describe-log-groups command docs](https://docs.aws.amazon.com/cli/latest/reference/logs/describe-log-groups.html) for usage details of the AWS command to list cloudwatch log groups
* See the [query docs](https://docs.aws.amazon.com/cli/latest/userguide/cli-usage-output.html#cli-usage-output-filter) for specifying query expressions with JMESPath to control AWS CLI output
* See the [filter docs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Filtering.html#Filtering_Resources_CLI) for matching and filtering resources based on property values, although note negation or testing for the absence of a property is not supported 

## Specifying log group retention

### Specifying log group retention in the AWS Console

The log group retention setting can be set after a log group has been created in the AWS Console. See the [AWS documentation](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#SettingLogRetention).

Note, you cannot specify log group retention when creating a log group within the AWS console. 

### Specifying log group retention using Cloudformation or Terraform

Both cloudformation and terraform support creation of cloudwatch log groups with a retention in days property in each case.
* https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html
* https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group

### Bulk update existing log groups with "Never Expire" retention

If a large number of log groups need to be updated, the following python3 script iterates through all cloudwatch log groups in all regions in a single AWS account and sets the retention period to 7 days where not already set.

```python3
import boto3


def main():
    update_retention_period_for_never_expiring_log_groups_in_all_regions(retention_in_days = 7)


def update_retention_period_for_never_expiring_log_groups_in_all_regions(retention_in_days):
    for region_name in all_regions():
        update_retention_period_for_never_expiring_log_groups(region_name, retention_in_days)


def update_retention_period_for_never_expiring_log_groups(region_name, retention_in_days):
    print("Processing log groups in region '{}' ...".format(region_name))

    logs_client = boto3.client("logs", region_name=region_name)

    for log_group in all_log_groups(logs_client):
        if "retentionInDays" not in log_group:
            update_log_group_retention_setting(logs_client, log_group["logGroupName"], retention_in_days)

    print("Processed all log groups in region '{}'.".format(region_name))


def update_log_group_retention_setting(logs_client, log_group_name, retention_in_days):
    logs_client.put_retention_policy(logGroupName=log_group_name, retentionInDays=retention_in_days)
    print(" - Updated retention setting for log group '{}' to {} days.".format(log_group_name, retention_in_days))


def all_regions():
    response = boto3.client("ec2").describe_regions()
    return [region["RegionName"] for region in response["Regions"]]


def all_log_groups(logs_client):
    all_log_groups = []
    paginator = logs_client.get_paginator("describe_log_groups")

    for page in paginator.paginate():
        all_log_groups.extend(page["logGroups"])

    return all_log_groups


if __name__ == "__main__":
    main()

```

### Automate retention setting using AWS Lambda

TODO: Example project using cloudwatch event rule daily trigger

